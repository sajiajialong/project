---
title: "Electronic Cigarette and Youth"
author: "Shengjie Sun & Chen Chen"
date: "2019-04-30"
categories: ["R"]
tags: ["R Markdown", "plot", "regression"]
---

```{r, warning=FALSE, message=FALSE, include=FALSE}
library(ggplot2)
library(dplyr)
library(GGally)
#library(plyr)
library(vcd)
#library(vcdExtra)
library(RColorBrewer)
setwd("/Users/husky/Desktop/5293/project/")

questions_num <- readr::read_csv("./output/attitude/Number of Questions.csv")
questions_num$Type <- factor(questions_num$Type, levels = c("Indirectly Related", "Directly Related"))

NYTS_2018_Full <- readr::read_csv("./data/2018-NYTS/nyts2018.csv")
load("./output/4-29.RData")
nyts2014 <- nyts2014

NYTS_2018_Selected <- NYTS_2018_Full %>% select(matches("Q(1|2|3|5)[A-Z]?$"),  contains('Q33'), 'Q27', 'Q35', 'Q68', 'Q69', 'Q28','Q29','Q30','Q31','Q34','Q36','Q37') %>%
  mutate(Q33A = ifelse(Q33A==1, "A", Q33A)) %>% mutate(Q33B = ifelse(Q33B==1, "B", Q33B)) %>%
  mutate(Q33C = ifelse(Q33C==1, "C", Q33C)) %>% mutate(Q33D = ifelse(Q33D==1, "D", Q33D)) %>%
  mutate(Q33E = ifelse(Q33E==1, "E", Q33E)) %>% mutate(Q33F = ifelse(Q33F==1, "F", Q33F)) %>%
  mutate(Q33G = ifelse(Q33G==1, "G", Q33G)) %>% mutate(Q33H = ifelse(Q33H==1, "H", Q33H)) %>%
  mutate(Q33I = ifelse(Q33I==1, "I", Q33I)) %>% mutate(Q33J = ifelse(Q33J==1, "J", Q33J)) %>%
  #mutate(Q33Fake = coalesce(Q33A,Q33B,Q33C,Q33D,Q33E,Q33F,Q33G,Q33H,Q33I,Q33J)) %>%
  mutate(Q33 = stringr::str_replace_all(paste(Q33A,Q33B,Q33C,Q33D,Q33E,Q33F,Q33G,Q33H,Q33I,Q33J, sep = ""),"NA","")) %>%
  mutate(Q5A = ifelse(Q5A==1, "A", Q5A)) %>% mutate(Q5B = ifelse(Q5B==1, "B", Q5B)) %>%
  mutate(Q5C = ifelse(Q5C==1, "C", Q5C)) %>% mutate(Q5D = ifelse(Q5D==1, "D", Q5D)) %>%
  mutate(Q5E = ifelse(Q5E==1, "E", Q5E)) %>% 
  select(matches("Q(1|2|3)$"), 'Q27','Q28','Q29','Q30','Q31','Q34','Q35','Q36','Q37','Q68','Q69', contains('Q33')) %>%
  filter(Q2!='*') %>% filter(Q3!='*') %>% filter(Q34!='*') %>% filter(Q27!='*') %>% 
  filter(Q35!='*') %>% filter(Q68!='*') %>% filter(Q69!='*') %>% filter(Q37!='*') %>% 
  filter(Q29!='**') %>% filter(Q1!='**')
```


# I. Introduction

# II. Description of the data source
We mainly collect row data from `Centers for Disease Control and Prevention` and the link is: https://www.cdc.gov/tobacco/data_statistics/surveys/nyts/data/index.html. 

Data are available in SAS, Microsoft Access, and Microsoft Excel formats, as well as PDFs of the questionnaire, codebook, and methodology report.

The data reveals the smoking and tobacco usage among youth and collected by doing survey called `National Youth Tobacco Survey (NYTS)`. Data from 1999 and 2018 are available but we only choose those from 2011 to 2018 as the topics releated to electronic cigarette appear in these surveys as early as 2011. The data for a particular year, say 2018 looks like following:

```{r data source, echo=FALSE, warning=FALSE, message=FALSE}
DT::datatable(NYTS_2018_Full[1:20,15:20])
```

Of course this is just a small part of the whole data. The 2019 NYTS data has 20189 observations and 373 variables. But actually the survey has only 88 questions and the reason for 373 rather than variables is that some questions contains several response and thus needing more columns to store and there are also many columns contains some statistical index calculated by `Centers for Disease Control and Prevention`. But all of those statistics are related to normal cigarettes and thus worth little to us.

The biggest problem for us is that the questions is different from year to year and we need to go through every questions in each year and select the questions that:

1. related to electronic cigarettes,
2. appear at least four years,
3. high quality and can reveal some "truth".

We divided all the questions related to e-cigarettes into indirectly related and directly related based on whether the words such as "e-cigaretted", "vape", etc appears in questions or just appears as an options/selections.

It is quite clear that the number of leaps from 2013 to 2014 and goes to peak in 2016. It's may worth to mention that all survey questionnaire of 2017 and 2018 are the same.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(data = questions_num) + 
  geom_col(aes(x=Year, y=Number, fill=Type)) + 
  scale_fill_manual(values = c("gray75", "gray45"))
```

All the questions selected are post in another blog called `All National Youth Tobacco Survey Questions Related to Electronic Cigarette`.

# III. Description of data import / cleaning / transformation
The criteria say we can not show codes but indeed for this part it is more efficient to explain combined with codes. Anyway, the data were download in csv file and imported with `readr::read_csv()` soomthly. Some `NA` is filtered and some questions with multiple responses stored in several in columns are combined together. Some responses are low quality and useless, for example some students may choose "I have never used e-cigarettes" and "I used e-cigarettes in last 30 days" at the same time. 

# IV. Analysis of missing values
Describe any patterns you discover in missing values.

# V. Results

## Trends and Patterns of the Usage of E-cigarettes

### Age
boxplot

### Days
ridge

### Sex
lines

## Analysis

### Attitudes of E-cigarettes
We combined the following five questions together:

Q27. Have you ever been curious about using an e-cigarette?

The reponse of the questions are shown by the color in lengend `Type`, The red lines indicates the response of those who are curious about e-cigarettes and the blue/green lines shows those of not curious.

Q35. Do you think that you will try an e-cigarette soon? 

Q36. Do you think you will use an e-cigarette in the next year?

Q37. If one of your best friends were to offer you an e-cigarette, would you use it?

Q3. What grade are you in?

Due to the limitation of `GGally::ggparcoord()`, only 2000 response can plot at one time. Therefore we sampled 2000 response randomly and the following patterns/findings are nearly repeats every times. 

```{r}
NYTS_2018_Selected %>% 
  filter(Q28 == 2) %>% 
  select('Q27','Q35','Q36','Q37','Q3') %>% 
  mutate(Type = ifelse(Q27<=2, "Curious","Not Curious")) %>%
  mutate(Q3 = readr::parse_integer(Q3)-1.5) %>%
  sample_n(2000) %>%
  ggparcoord(columns = 2:5, scale = "globalminmax", splineFactor = 10, alphaLines = 0.5, groupColumn = 6) +
  scale_y_discrete(limits=c("Definitely yes","Probably yes","Probably not","Definitely not")) +
  labs(x="Questions",y="Responses")
```

The most obvious pattern are whether youth are curious about the e-cigarettes almost determines whether they will try e-cigarettes. 

If we exam the pictures more carefully, we can see the effects of friends. The lines accross `Probably yes` and `Definitely yes` from `Q37` are denser than those from `Q35` and `Q36`. This indicates a little bit of the reasons of why youth use e-cigarettes. If you can not see clearly due to the bad representation of the samples, never mind, we will study this more throughtly in the following parts. 

### What are the reasons youths have used ecigarettes? (Select one or more)

A. I have never tried an e-cigarette

B. Friend or family member used them

C. To try to quit using other tobacco products, such as cigarettes

D. They cost less than other tobacco products, such as cigarettes

E. They are easier to get than other tobacco products, such as cigarettes

F. Famous people on TV or in movies use them

G. They are less harmful than other forms of tobacco, such as cigarettes

H. They are available in flavors, such as mint, candy, fruit, or chocolate

I. They can be used in areas where other tobacco products, such as cigarettes, are not allowed

J. I used them for some other reason

As indicateds in the subtitles, this is a questions with several responses. Generally, this kind of data are very difficult to visualize. We will exam these data step by step.

First, we clean the data a little bit and create a new columns called `Q33` showing the response in a human reading way. And the filter `Q33A` as we only care about those have tried e-cigarettes. 
```{r}
Reasons <- NYTS_2018_Selected %>% filter(is.na(Q33A)) %>% select(matches("Q(1|2|3)$"), contains('Q33'))
Reasons[19:25,5:14]
```
You know what? There are totally 159 different combination appears! But mathematically speaking, there could be 512 different choice at most. So, definitely, there are some patterns behind. 

In the following plot, we only count the frequency of each choice without considering the combination. It if quite clear that choice B: Friend or family member used them is the major reasons for youth to try e-cigarettes. And the second is e-cigarettes are available in flavors, such as mint, candy, fruit, or chocolate. And then they are less harmful than other forms of tobacco, such as cigarettes if we do not consider other reasons, i.e. choice J. Health is not the major reason for youth to choice e-cigarettes!! And if only counts less than half of influence of friends and familys!!

```{r}
NYTS_2018_Full %>% select(contains('Q33')) %>% 
  select(-Q33A) %>% as.matrix() %>% colSums(.,na.rm = T) %>% 
  tibble(Choice = c("B","C","D","E","F","G","H","I","J"), Count = .) %>%
  ggplot() + 
  geom_col(aes(x=Choice, y=Count))
```

```{r}
# Reasons %>% count(Q33) %>% filter(n>=10) %>% arrange(desc(n)) %>% 
#   filter(n!=75) %>% mutate(Related_to_B = ifelse(stringr::str_detect(Q33, "B"), 'Yes', 'No')) %>%
#   mutate(Q33 = forcats::fct_reorder(Q33, n, .desc=FALSE)) %>%
#   mutate(Count = n) %>%
#   ggplot() + 
#   geom_col(aes(x = Q33, y=Count, fill=Related_to_B)) +
#   coord_flip()
```




```{r, warning=FALSE, message=FALSE, include=FALSE}
# import the data
library(plyr)
library(vcdExtra)
e_use_2014<- data.frame(year=rep(2014,22007),try=nyts2014$qn31,days=nyts2014$qn35,gender=nyts2014$qn2)
age_first_2014<- data.frame(year=rep(2014,22007),nyts2014$qn34,gender=nyts2014$qn2)
regular_e_2014<- data.frame(key=rep("e",22007),year=rep(2014,22007),days=nyts2014$qn35,gender=nyts2014$qn2)
regular_c_2014<- data.frame(key=rep("c",22007),year=rep(2014,22007),days=nyts2014$qn13,gender=nyts2014$qn2)
regular_2014<- rbind(regular_e_2014,regular_c_2014)
newspaper_2014<- data.frame(year=rep(2014,22007),nyts2014$qn69,gender=nyts2014$qn2)
supermarket_2014<- data.frame(year=rep(2014,22007),nyts2014$qn70,gender=nyts2014$qn2)
TV_2014<- data.frame(year=rep(2014,22007),nyts2014$qn71,gender=nyts2014$qn2)


e_use_2015<- data.frame(year=rep(2015,17711),try=nyts2015$Qn28,days=nyts2015$Qn32,gender=nyts2015$Qn2)
age_first_2015<- data.frame(year=rep(2015,17711),nyts2015$Qn31,gender=nyts2015$Qn2)
regular_e_2015<- data.frame(key=rep("e",17711),year=rep(2015,17711),days=nyts2015$Qn32,gender=nyts2015$Qn2)
regular_c_2015<- data.frame(key=rep("c",17711),year=rep(2015,17711),days=nyts2015$Qn12,gender=nyts2015$Qn2)
regular_2015<- rbind(regular_e_2015,regular_c_2015)
internet_2015<- data.frame(year=rep(2015,17711),nyts2015$Qn69,gender=nyts2015$Qn2)
supermarket_2015<- data.frame(year=rep(2015,17711),nyts2015$Qn71,gender=nyts2015$Qn2)
TV_2015<- data.frame(year=rep(2015,17711),nyts2015$Qn72,gender=nyts2015$Qn2)


e_use_2016<- data.frame(year=rep(2016,20675),try=nyts2016$Qn26,days=nyts2016$Qn31,gender=nyts2016$Qn2)
age_first_2016<- data.frame(year=rep(2016,20675),nyts2016$Qn30,gender=nyts2016$Qn2)
regular_e_2016<- data.frame(key=rep("e",20675),year=rep(2016,20675),days=nyts2016$Qn31,gender=nyts2016$Qn2)
regular_c_2016<- data.frame(key=rep("c",20675),year=rep(2016,20675),days=nyts2016$Qn13,gender=nyts2016$Qn2)
regular_2016<- rbind(regular_e_2016,regular_c_2016)
internet_2016<- data.frame(year=rep(2016,20675),fre=nyts2016$Qn73,gender=nyts2016$Qn2)
newspaper_2016<- data.frame(year=rep(2016,20675),fre=nyts2016$Qn74,gender=nyts2016$Qn2)
supermarket_2016<- data.frame(year=rep(2016,20675),fre=nyts2016$Qn75,gender=nyts2016$Qn2)
TV_2016<- data.frame(year=rep(2016,20675),fre=nyts2016$Qn76,gender=nyts2016$Qn2)



e_use_2017<- data.frame(year=rep(2017,17872),try=nyts2017$Qn28,days=nyts2017$Qn31,gender=nyts2017$Qn2)
age_first_2017<- data.frame(year=rep(2017,17872),nyts2017$Qn29,gender=nyts2017$Qn2)
regular_e_2017<- data.frame(key=rep("e",17872),year=rep(2017,17872),days=nyts2017$Qn31,gender=nyts2017$Qn2)
regular_c_2017<- data.frame(key=rep("c",17872),year=rep(2017,17872),days=nyts2017$Qn11,gender=nyts2017$Qn2)
regular_2017<- rbind(regular_e_2017,regular_c_2017)
internet_2017<- data.frame(year=rep(2017,17872),fre=nyts2017$Qn78,gender=nyts2017$Qn2)
newspaper_2017<- data.frame(year=rep(2017,17872),fre=nyts2017$Qn79,gender=nyts2017$Qn2)
supermarket_2017<- data.frame(year=rep(2017,17872),fre=nyts2017$Qn80,gender=nyts2017$Qn2)
TV_2017<- data.frame(year=rep(2017,17872),fre=nyts2017$Qn81,gender=nyts2017$Qn2)



e_use_2018<- data.frame(year=rep(2018,20189),try=nyts2018$Qn28,days=nyts2018$Qn31,gender=nyts2018$Qn2)
age_first_2018<- data.frame(year=rep(2018,20189),nyts2018$Qn29,gender=nyts2018$Qn2)
regular_e_2018<- data.frame(key=rep("e",20189),year=rep(2018,20189),days=nyts2018$Qn31,gender=nyts2018$Qn2)
regular_c_2018<- data.frame(key=rep("c",20189),year=rep(2018,20189),days=nyts2018$Qn11,gender=nyts2018$Qn2)
regular_2018<- rbind(regular_e_2018,regular_c_2018)
internet_2018<- data.frame(year=rep(2018,20189),fre=nyts2018$Qn78,gender=nyts2018$Qn2)
newspaper_2018<- data.frame(year=rep(2018,20189),fre=nyts2018$Qn79,gender=nyts2018$Qn2)
supermarket_2018<- data.frame(year=rep(2018,20189),fre=nyts2018$Qn80,gender=nyts2018$Qn2)
TV_2018<- data.frame(year=rep(2018,20189),fre=nyts2018$Qn81,gender=nyts2018$Qn2)

```


One thing we are interested in is how likely people become "addictive" after they try e-cigarettes once or twice and become regular smokers. We define "addictive" and "regular smokers" as thoses who spend more than two days to smoke e-cigarettes within 30 days. This question is addressed in two steps: 
1) what is the percentage of regular smokers in the whole population?
2) what is the percentage of regular smokers among those who tried to smoke once or twice?
And in order to give our readers a direct impression about the extent of addction, we compare with the data of ordinary cigarettes. The results are shown in the following several figures.
```{r, warning=FALSE, message=FALSE, include=FALSE}
regular<- rbind(regular_2014,regular_2015,regular_2016,regular_2017,regular_2018)
index<- complete.cases(regular)
regular<- regular[index,]
my.reg.per<- function(x){
  my.reg.per1<- function(y){return(sum(y$days>2)/dim(y)[1])}
  return(daply(x,.(year),my.reg.per1))
}
regular_per<- daply(regular,.(key),my.reg.per)
```

```{r}
ggplot()+geom_line(aes(x=2014:2018,y=regular_per[1,],color="e-cigarette"),size=1.5)+
         geom_line(aes(x=2014:2018,y=regular_per[2,],color="cigarette"),size=1.5)+
         xlab("year")+ylab("percentage of regular smoker")+ggtitle("percentage of regular smoker of e-cigarette/cigarette in each year")
```

The lines in the figure answers the first question, showing above shows that there about 4.5% to 9% regular e-cigarettes users in the youth, compared to 3% to 4% regular cigarettes smakers in the youth. This result is probably contradictary to our commen sense: there are more cigarettes smokers around us than e-cigarettes smakers. Our commen sense may be true for adults, however, it is a different story in youth group. E-cigarettes are more popular in youth group.

Another thing that worths to notices is that the percentage of regular e-cigarettes smokers is generally increases while the percentage of cigarettes is generally decreasing, suggesting e-cigarettes are becoming a trend among youth.

In addition to the investigations in the whole youth population, gender is also considered as an important factor: we would like to find out whether there is a huge difference between different genders with respect to smoking. Here is the result:

```{r}
regular.male_per<- daply(regular[regular$gender==1,],.(key),my.reg.per)
regular.female_per<- daply(regular[regular$gender==2,],.(key),my.reg.per)
ratio<- regular.female_per/regular.male_per
ggplot()+ geom_line(aes(x=2014:2018,y=ratio[1,],color="e-cigarette"))+
          geom_line(aes(x=2014:2018,y=ratio[2,],color="cigarette"))+
          xlab("year")+ylab("ratio:female/male ")+
          ggtitle("ratio of female and male regular smokers")

```

It seems that males are more "fashionable" in regards to smoking. There is higher female precentage in traditional smoking, than in the new-born e-cigarettes smoking.

To answer the second question, we plot the percentage of regular smokers among those who tried to smoke once or twice. Ther higher the percentage is, the more likely people sink into it.

```{r, warning=FALSE, message=FALSE, include=FALSE}
e_use<- rbind(e_use_2014,e_use_2015,e_use_2016,e_use_2017,e_use_2018)
index<- complete.cases(e_use)
e_use<- e_use[index,]
my.add.per<- function(x){return(sum(x$days>2)/dim(x)[1])}
addiction.rate<- daply(e_use[e_use$try==1,],.(year),my.add.per)
addiction.rate.male<- daply(e_use[e_use$try==1&e_use$gender==1,],.(year),my.add.per)
addiction.rate.female<- daply(e_use[e_use$try==1&e_use$gender==2,],.(year),my.add.per)
```

```{r}
ggplot()+geom_line(aes(x=2014:2018,y=addiction.rate.male,color="male"))+
         geom_line(aes(x=2014:2018,y=addiction.rate,color="overall"),size=1)+
         geom_line(aes(x=2014:2018,y=addiction.rate.female,color="female"))+
         xlab("year")+ylab("addiction rate")+
         ggtitle("percentage of those who tried e-cigarette to be addicted to it")
```

The figure above shows that 25% of those who are willing to try e-cigarettes turn out to be regular smokers. Tha explaination for this can be multiple: it is possible that in the beginning 1/4 of the triers are determined to be regular smokers. Or it is possible that e-cigarettes can attract 1/4 of the triers. Gender also plays a role in the process. Female are less likely to turn into a regular e-cigarette smoker than males.

###################

As previously shown, e-cigarettes seem to become more and more popular among young people. Not only is it reflected in the percentage of regular smokers, but also reflected in the age when people try e-cigarettes for the first time. 

```{r, warning=FALSE, message=FALSE, include=FALSE}
colnames(age_first_2014)<- c("year","age","gender")
colnames(age_first_2015)<- c("year","age","gender")
colnames(age_first_2016)<- c("year","age","gender")
colnames(age_first_2017)<- c("year","age","gender")
colnames(age_first_2018)<- c("year","age","gender")
age_first<- rbind(age_first_2014,age_first_2015,age_first_2016,age_first_2017,age_first_2018)

index<- complete.cases(age_first)
age_first<- age_first[index,]
age_first$age<- age_first$age+6
age_first1<- age_first[age_first$age >8,]
age_first1$year<- as.factor(age_first1$year)
```

```{r}
ggplot(data = age_first1)+geom_boxplot(aes(y=age,x=year,fill=year))+
      xlab("year")+ylab("age of first-time smoking")+
       ggtitle("boxplot of age of trying e-cigarette for the first time")
```
The figure above shows that the age when the youth try their first taste of e-cigarettes becomes younger. In the investigation in 2014, it happened at the age of 15. Now in 2018, it happens at the age of 14.

##################

One one hand, we see the popularity of e-cigarettes among youth. On the other hand, the days people spend to use e-cigarettes is increasing. We suspect it is partially due to the popularity of e-cigarettes. One possibility is that when people realize e-cigarette is a fishionable thing, they may have less motive to restrain themselves from it. Another reason we can think of is that people with more years of smoking experience tend to smoke more often. E-cigarettes is a new thing, so the percentage of many-years smoker is still increasing.

```{r, warning=FALSE, message=FALSE, include=FALSE}
regular[regular$days==1,]$days=0
regular[regular$days==7,]$days=30
regular[regular$days==6,]$days=sample(20:29,sum(regular$days==6),replace = T)
regular[regular$days==5,]$days=sample(10:19,sum(regular$days==5),replace = T)
regular[regular$days==4,]$days=sample(6:9,sum(regular$days==4),replace = T)
regular[regular$days==3,]$days=sample(3:5,sum(regular$days==3),replace = T)
regular[regular$days==2,]$days=sample(1:2,sum(regular$days==2),replace = T)
```

```{r}
ggplot(data = regular[regular$key=="e"&regular$days>0,])+geom_boxplot(aes(y=days,x=as.factor(year),fill=as.factor(year)))+
  xlab("year")+ylab("days of smoking within one month")+
  ggtitle("boxplot of days of smoking within one month")
```
The figure above shows that in 2014, the average days people spend in smoke was 9 days. Afterwards it gradually increases to 14 days in 2018.

#############
The questionair includs questions about advertisement in four kinds of media: internet, newspaper, supermarkets, TV. It asks how often do youth see advertisement of e-cigarette in those media. Five options are given: never, rarely, sometimes, most of the time, always.

```{r}

adv<- rbind(data.frame(source=rep("internet",dim(internet_2018)[1]),internet_2018),
            data.frame(source=rep("newspaper",dim(newspaper_2018)[1]), newspaper_2018),
            data.frame(source=rep("supermarket",dim(supermarket_2018)[1]),supermarket_2018),
            data.frame(source=rep("TV",dim(TV_2018)[1]),TV_2018))

index<-complete.cases(adv)
adv<- adv[adv$fre>1 & index,]
adv$fre<- as.factor(adv$fre)
adv$source<-as.factor(adv$source)
levels(adv$fre)<- c("Never","Rarely","Sometimes","Most of the time","Always")
platte <- rev(brewer.pal(5, 'RdBu'))
vcd::mosaic(fre ~ source, adv,
            direction = c("v", "h"),
            gp = gpar(fill = platte),
            rot_labels=c(0,90,0,0))
```

From the figure above, we are able to conclude that less advertisements are put in newspaper. Relatively more ads are put in internet, supermarket and TV. It is possibly because less and less people read newspapers. It looks like it is more often to see advertisement of e-cigarettes in supermarket. Though youth may show up on the internet more often, supermarket is the main battleground for e-cigarette to win custumers. One explaination is that people with purchasing power are more likely to go to supermarket, and manufacturer wants to win over those potential clinets.




